<template>
    <div class="row">
        <div class="col-md-6">
            <panel class="character">
                <div class="details">
                    <div class="level">
                        <div class="data">
                            <span>Level</span>
                            <b>{{ character.level }}</b>
                        </div>
                        <el-progress :percentage="getExperienceBar(level).percentage" :show-text="false"
                                     :stroke-width="12"/>
                    </div>

                    <div class="skills">
                        <div class="skill">
                            <i class="mdi mdi-auto-fix icon"></i>
                            <div class="data">
                                <b>Magic Level</b>
                                <span>14</span>
                            </div>
                        </div>

                        <div class="skill">
                            <i class="mdi mdi-sword icon"></i>
                            <div class="data">
                                <b>Sword fighting</b>
                                <span>125</span>
                            </div>
                        </div>

                        <div class="skill">
                            <i class="mdi mdi-shield icon"></i>
                            <div class="data">
                                <b>Shielding</b>
                                <span>119</span>
                            </div>
                        </div>
                    </div>
                </div>
            </panel>
        </div>

        <div class="col-md-6">
            <panel class="character">
                <div class="stats">
                    <div class="stat full">
                        <div class="label-progress">
                            <b>HP</b>
                            <span>{{ hitpoints.format() }}</span>
                        </div>
                        <el-progress :percentage="hitpoints"
                                     :show-text="false"
                                     :stroke-width="12"
                                     status="hitpoints"/>
                    </div>

                    <div class="stat full">
                        <div class="label-progress">
                            <b>Mana</b>
                            <span>{{ manapoints.format() }}</span>
                        </div>
                        <el-progress :percentage="manapoints"
                                     :show-text="false"
                                     :stroke-width="12"
                                     status="manapoints"/>
                    </div>

                    <div class="stat">
                        <i class="mdi mdi-speedometer icon"></i>
                        <div class="data">
                            <b>Speed</b>
                            <span>{{ speed }}</span>
                        </div>
                    </div>

                    <div class="stat">
                        <i class="mdi mdi-weight icon"></i>
                        <div class="data">
                            <b>Capacity</b>
                            <span>{{ capacity }} oz.</span>
                        </div>
                    </div>
                </div>
            </panel>
        </div>
    </div>
</template>

<script>
    Number.prototype.format = function (n, x) {
        var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
        return this.toFixed(Math.max(0, ~ ~ n)).replace(new RegExp(re, 'g'), '$&.');
    };

    export default {
        props: ['character', 'experience'],

        computed: {
            level () {
                return this.experience.sort((a, b) => b.id - a.id)[0]
            },

            hitpoints () {
                switch (this.character.vocation) {
                    case 'Knight':
                    case 'Elite Knight':
                        return (this.character.level - 8) * 15 + 185
                    case 'Paladin':
                    case 'Royal Paladin':
                        return (this.character.level - 8) * 10 + 185
                    default:
                        return (this.character.level - 8) * 5 + 145
                }
            },

            manapoints () {
                switch (this.character.vocation) {
                    case 'Druid':
                    case 'Sorcerer':
                    case 'Elder Druid':
                    case 'Master Sorcerer':
                        return (this.character.level - 8) * 30 + 90
                    case 'Paladin':
                    case 'Royal Paladin':
                        return (this.character.level - 8) * 15 + 90
                    default:
                        return (this.character.level - 8) * 5 + 50
                }
            },

            speed () {
                return 220 + (2 * (this.character.level - 1))
            },

            capacity () {
                switch (this.character.vocation) {
                    case 'Knight':
                    case 'Elite Knight':
                    case 'Paladin':
                    case 'Royal Paladin':
                        return (this.character.level - 8) * 25 + 470
                    default:
                        return (this.character.level - 8) * 10 + 400
                }
            }
        },

        methods: {
            getExperienceBar (advance) {
                const nextLevel = advance.level + 1
                const nextLevelExp = ((50 * Math.pow((nextLevel - 1), 3)) - (150 * Math.pow((nextLevel - 1), 2)) + (400 * (nextLevel - 1))) / 3
                const currentExp = advance.experience
                const expToNextLevel = 50 * Math.pow(advance.level, 2) - 150 * advance.level + 200
                const expLeft = nextLevelExp - currentExp
                const currentLeveledExp = expToNextLevel - expLeft
                const percentage = parseInt((currentLeveledExp * 100) / expToNextLevel)

                return this.experience
                    ? { leftExperience: expLeft, percentage: percentage }
                    : { leftExperience: 0, percentage: 0 }
            }
        }
    }
</script>